<!doctype html>
<html lang="en">
<head>
  <title>MedBuddy Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/static/style.css">
</head>

<body>
<!-- HEADER -->
<header class="bento-header">
  <button class="hamburger" onclick="toggleMenu()" aria-label="Menu">
    <span></span>
    <span></span>
    <span></span>
  </button>

  <h2 class="page-title" >MedBuddy Admin</h2>
  <a href="/admin/logout" class="logout-btn">Logout</a>
</header>

<!-- SIDE PANEL -->
<aside id="sidePanel" class="side-panel">
  <h3>Doctor Settings</h3>

  <form method="post" action="/admin/settings">
    <label>WhatsApp Number</label>
    <input name="doctor_whatsapp"
           value="{{ settings.doctor_whatsapp }}">

    <label>UPI ID / Payment Link</label>
    <input name="upi_link"
           value="{{ settings.upi_link }}">

    <button type="submit">Save</button>
  </form>
</aside>

<!-- MAIN DASHBOARD -->
<main class="dashboard">
  <!-- STATS BENTO -->
  <section class="stats-bento">
    <div class="stat-card total">
      <span>Total</span>
      <h1>{{ stats.total }}</h1>
    </div>

    <div class="stat-card reserved">
      <span>Reserved</span>
      <h1>{{ stats.reserved }}</h1>
    </div>

    <div class="stat-card confirmed">
      <span>Confirmed</span>
      <h1>{{ stats.confirmed }}</h1>
    </div>

    <div class="stat-card today">
      <span>Today</span>
      <h1>{{ stats.today }}</h1>
    </div>
  </section>


  <!-- FILTER BAR -->
  <section class="bento filter-bar">
    <form method="get" class="filter-form">
      <input name="search"
             placeholder="Search name / mobile / code"
             value="{{ search or '' }}">

      <input type="date" name="from_date" value="{{ from_date or '' }}">
      <input type="date" name="to_date" value="{{ to_date or '' }}">

      <select name="status">
        <option value="">All</option>
        <option value="RESERVED">Reserved</option>
        <option value="CONFIRMED">Confirmed</option>
        <option value="CANCELLED">Cancelled</option>
        <option value="DONE">Done</option>
      </select>

      <button>Apply</button>
    </form>
  </section>

  <!-- APPOINTMENTS -->
  <section class="bento appointments-box">
    <h3>Appointments</h3>

    <div class="appointments-scroll">
      {% for a in appointments %}
      <div class="appointment-card">

        <div class="card-top">
          <div>
            <strong>{{ a.patient_name }}</strong>
            <small>{{ a.mobile }}</small>
          </div>

          <span class="status {{ a.status }}">{{ a.status }}</span>
        </div>

        <div class="card-mid">
          {{ a.appointment_date }} â€¢ {{ a.slot_time }}<br>
          <small>{{ a.confirmation_code }}</small>
        </div>

        <form method="post" action="/admin/update/{{ a.id }}">
          <textarea name="remarks"
                    placeholder="Internal notes">{{ a.admin_remarks or '' }}</textarea>

          <input name="meeting_link"
                 placeholder="Meeting link"
                 value="{{ a.meeting_link or '' }}">

          <div class="card-actions">
            <select name="status">
              <option value="RESERVED" {% if a.status=="RESERVED" %}selected{% endif %}>RESERVED</option>
              <option value="CONFIRMED" {% if a.status=="CONFIRMED" %}selected{% endif %}>CONFIRMED</option>
              <option value="CANCELLED" {% if a.status=="CANCELLED" %}selected{% endif %}>CANCELLED</option>
              <option value="DONE" {% if a.status=="DONE" %}selected{% endif %}>DONE</option>
            </select>

            <button>Update</button>

            {% if a.status == "RESERVED" %}
            <a class="wa-btn" target="_blank"
               href="https://wa.me/{{ a.mobile }}?text={{ settings.reservation_message
               .replace('{{name}}', a.patient_name)
               .replace('{{date}}', a.appointment_date)
               .replace('{{time}}', a.slot_time)
               .replace('{{upi}}', settings.upi_link)
               | urlencode }}">
              ðŸ’° Payment
            </a>
            {% endif %}

            {% if a.status == "CONFIRMED" %}
            <a class="wa-btn" target="_blank"
               href="https://wa.me/{{ a.mobile }}?text={{ confirmation_message
               .replace('{{name}}', a.patient_name)
               .replace('{{code}}', a.confirmation_code)
               .replace('{{date}}', a.appointment_date)
               .replace('{{time}}', a.slot_time)
               .replace('{{meeting_link}}', a.meeting_link)
               | urlencode }}">
              ðŸ“² Confirm
            </a>
            {% endif %}
          </div>
        </form>

      </div>
      {% endfor %}
    </div>
  </section>

  <!-- SLOTS -->
  <section class="bento slots-box">
    <h3>Slots</h3>

    <form method="post" action="/admin/slots" class="slot-form">
      <input type="date" name="slot_date" required>
      <input type="time" name="start_time" required>
      <input type="time" name="end_time" required>
      <button>Add Slot</button>
    </form>

    <div class="slots-grid">
      {% for s in slots %}
      <div class="slot-chip {{ 'booked' if s.is_booked }}">
        <strong>{{ s.slot_date }}</strong>
        <div>{{ s.start_time }} â€“ {{ s.end_time }}</div>
        <small>{{ "BOOKED" if s.is_booked else "FREE" }}</small>
      </div>
      {% endfor %}
    </div>
  </section>

</main>

<!-- JS -->
<script>
function toggleMenu() {
  document.getElementById("sidePanel").classList.toggle("open");
}
</script>

</body>
</html>
